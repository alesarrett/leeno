<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="_Disattivate" script:language="StarBasic">REM  *****  BASIC  *****
&apos;********************************************************
Sub Formula_magica___

		oSheet = ThisComponent.currentController.activeSheet
		iRow= Range2Cell

	if oSheet.GetCellByPosition( 2, iRow ).cellstyle  = &quot;comp 1-a&quot; or _
		oSheet.GetCellByPosition( 5, iRow ).cellstyle  = &quot;comp 1-a&quot;	then	
		sSimbDividente = &quot;  &gt;| &quot;

		sComp=oSheet.GetCellByPosition( 2, iRow ).string
		if InStr(1, sComp, sSimbDividente) &lt;&gt; 0 then
			sComp = Left(sComp,InStr(1, sComp, sSimbDividente)-1) &apos; Restituisce la stringa 
		end if

		sString4 = oSheet.GetCellByPosition( 4, iRow ).formula
		sString5 = oSheet.GetCellByPosition( 5, iRow ).formula
		sString6 = oSheet.GetCellByPosition( 6, iRow ).formula
		sString7 = oSheet.GetCellByPosition( 7, iRow ).formula
		sString8 = oSheet.GetCellByPosition( 8, iRow ).formula

		if sString4 &lt;&gt; &quot;&quot; then 
						 sString4 =	&quot;(&quot; &amp; sString4 &amp;&quot;)&quot;
						 iTag = 1
		end if	

		if sString5 &lt;&gt; &quot;&quot; then 
						 sString5 =	&quot;(&quot; &amp; sString5 &amp;&quot;)&quot; 
						 iTag = 1
		end if	
		if sString4 &lt;&gt; &quot;&quot; and sString5 &lt;&gt; &quot;&quot; and sString6 &lt;&gt; &quot;&quot;  then 
						 sString5 =	&quot;*&quot; &amp; sString5 	
				if itag = 1 then 
					sString5 =	&quot;*&quot; &amp; sString5
				end if			
		end if	
	&apos;	sString5 = sString4 &amp; sString5
		
			
		if sString6 &lt;&gt; &quot;&quot; then 
						 sString6 =	&quot;(&quot; &amp; sString6 &amp;&quot;)&quot; 
						 iTag = 1
		end if
		if sString5 &lt;&gt; &quot;&quot;  and sString6 &lt;&gt; &quot;&quot; and sString7 &lt;&gt; &quot;&quot; then 
						 sString6 =	&quot;*&quot; &amp; sString6 
				else
				if itag = 1 then 
					sString6 =	&quot;*&quot; &amp; sString6
				end if			
		end if	

		
		if sString7 &lt;&gt; &quot;&quot; then 
						 sString7 =	&quot;(&quot; &amp; sString7 &amp;&quot;)&quot; 
						 iTag = 1
		end if	
		if sString6 &lt;&gt; &quot;&quot; and sString7 &lt;&gt; &quot;&quot; and sString8 &lt;&gt; &quot;&quot; then 
						 sString7 =	&quot;*&quot; &amp; sString7 
				else
				if itag = 1 then 
					sString7 =	&quot;*&quot; &amp; sString7
				end if			
		end if	
	&apos;	sString7 = sString6 &amp; sString7			
		
		if sString8 &lt;&gt; &quot;&quot; then 
						 sString8 =	&quot;(&quot; &amp; sString8 &amp;&quot;)&quot; 
						 iTag = 1
		end if	
		if sString7 &lt;&gt; &quot;&quot; or  sString8 &lt;&gt; &quot;&quot; then 
						 sString8 =	&quot;*&quot; &amp; sString8
						else
				if itag = 1 then 
					sString8 =	&quot;*&quot; &amp; sString8
				end if			
		end if
	&apos;	sString8 = sString7 &amp; sString8	
		sString8 = sString4 &amp; sString5 &amp; sString6 &amp; sString7 &amp; sString8
		&apos;Source = &quot;il mio cane&quot;
		Search = &quot;=&quot;
		NewPart = &quot;&quot;		
		sString8 = Replace_G (sString8 , Search , NewPart )			
		sTringTUTTA = sComp &amp; sSimbDividente &amp; sString8 

&apos;print sTringTUTTA

		oSheet.GetCellByPosition( 2, iRow ).Formula = sTringTUTTA
	end if&apos;

End Sub
Sub Inserisci_Utili_old &apos; o Oneri di sicurezza o Maggiorazione %
	nome_sheet = thisComponent.currentcontroller.activesheet.name
	if SE_contabilita = 0 and nome_sheet &lt;&gt; &quot;CONTABILITA&quot;  then
		exit sub
	end if

	&apos;_____________________
	chiudi_dialoghi  &apos; chiude tutti i dialoghi
	&apos;_____________________
	
	If thisComponent.Sheets.hasByName(&quot;S1&quot;) Then &apos; se la sheet esiste
		If ThisComponent.Sheets.getByName(&quot;S1&quot;).GetCellByPosition(7,326).value = 3 then
				Inserisci_Utili_giuserpe
			else
				Inserisci_Utili_Classica
		end if
	end if
end sub
Sub Inserisci_Incid_manodopera()&apos; obsoleta ... cancellare poi...

dim nome as string
Dim oDoc As Object
Dim oSheets As Object
dim oCelle As Object
Dim CellRangeAddress As New com.sun.star.table.CellRangeAddress
Dim CellAddress As New com.sun.star.table.CellAddress
dim lrow as integer
dim lcol as integer
dim lrow2 as integer
Dim oView As Object
Dim nome_sheet as string
Dim OcalcSheet as Object
Dim I as long
Dim oSheet_num as integer
Dim iflag
	oDoc=thisComponent
	oDoc.SupportsService(&quot;com.sun.star.sheet.SpreadsheetDocument&quot;)
	oCelle=oDoc.getCurrentSelection().getCellAddress()
	lrow=oCelle.Row	
	oSheets = odoc.Sheets
	oView = ThisComponent.CurrentController
	nome_sheet = oView.GetActiveSheet.Name
	
&apos;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
	iflag =	CNTR_Analisi (lrow)&apos; controlla se la riga è buona
			sFlag = &quot;A&quot;

	if iflag = 1 then
		exit sub
	end if
	oCalcSheet = ThisComponent.currentController.activeSheet
&apos;	oCalcSheet = oSheets.GetByIndex(0)
&apos;	For I = 0 to oSheets.Count -1 
&apos;		oCalcSheet = oSheets(I) &apos;recuperiamo la tabella
&apos;		if oCalcSheet.Name = nome_sheet Then
&apos;			oSheet_num = I
&apos;		end if
&apos;	Next I
&apos;	oSheets = oDoc.Sheets (oCalcSheet)
&apos;	CellRangeAddress.Sheet = oCalcSheet   
&apos;	CellRangeAddress.StartColumn = 0
&apos;	CellRangeAddress.StartRow = lrow
&apos;	CellRangeAddress.EndColumn = 250 
&apos;	CellRangeAddress.EndRow = lrow
&apos;	print lrow
&apos;	oSheets.insertCells(CellRangeAddress, com.sun.star.sheet.CellInsertMode.ROWS)&apos; inserisce delle righe vuote
&apos;exit sub
&apos;print
&apos;	lrow2 = lrow  +1
&apos;	CellAddress.Sheet = oSheet_num   
&apos;	CellRangeAddress.StartRow = lrow2
&apos;	CellRangeAddress.EndRow = lrow2
&apos;	CellAddress.Column = 0
&apos;	CellAddress.Row = lrow
&apos;	oSheets.copyRange(CellAddress, CellRangeAddress)

	if sflag = &quot;A&quot; then &apos; ????
			lcol = 1
		else
			lcol = 3
	end if
&apos;	oCell = oSheets.GetCellByPosition( lcol , lrow+1)	
&apos;	ThisComponent.CurrentController.Select(oCell)
	
	
	&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos;
	
	oSheet = ThisComponent.currentController.activeSheet &apos; sheet corrente             
  oCelle=thisComponent.getCurrentSelection().getCellAddress()    
 lrow=oCelle.Row        
  oCell = oSheet.GetCellByPosition(0,lrow )      
  ThisComponent.CurrentController.Select(oCell)
    
   &apos;&apos;&apos;&apos;&apos;&apos;&apos;&apos; copia gli utili %
	oDoc = ThisComponent
	DocView=oDoc.getCurrentController()
	oSheet1=oDoc.NamedRanges.utili.ReferredCells &apos; utili è il nome del range
	oCelle=oDoc.getCurrentSelection().getCellAddress()  &apos; indirizzo cella attiva (qui)
	oSheet2 = oDoc.Sheets.getByName(oDoc.currentcontroller.activesheet.name) &apos; sheet corrente dove incollare
	oQuellRangeAddresse = osheet1.getRangeAddress &apos;
 &apos;   oSheet2.copyRange(oCelle,oQuellRangeAddresse)
    	oCell = oSheet.GetCellByPosition( 7 , lrow)	
	ThisComponent.CurrentController.Select(oCell)
&apos;	print
	Range_Somma_locale_analisi_incidenza (6)
	oCell.cellstyle=&quot;An-lavoraz-dx% ins&quot;
	msgbox &quot;Controlla la formula... potrebbe non essere giusta!!!&quot;
END SUB
&apos; Questa Ã¨ molto traballante... da rivedere completamente...
Sub Main_Riordina_Analisi_Alfabetico_old &apos; riordina le analisi in ordine alfabetico
&apos;-----------------------------------&apos; trovando anche i codici doppi.
&apos;	oSheets = ThisComponent.Sheets
	 oSheets = ThisComponent.getSheets()
if msgbox (&quot; Mi hai chiesto di riordinare le analisi in ordine alfabetico.. &quot; &amp; CHR$(10) _
				&amp;&quot; E&apos; un&apos;operazione lunghetta.... Sei certo di volerlo fare adesso? &quot;&amp; CHR$(10)_
				&amp;&quot; L&apos;undo potrebbe risultare impossibile... non sarebbe meglio salvare prima il file? &quot; &amp; CHR$(10) _
				&amp;&quot;           Che faccio... Proseguo ?...  &quot;,292, &quot;Attento!!! Hai salvato?&quot;) = 7 then
			exit sub
end if	 


&apos;	on error goto riprendi
	mydoc = StarDesktop.CurrentComponent
	myView = myDoc.CurrentController
dim lrowS as long
dim lrow as long
dim lrowDove as long
dim oOrigine as object
&apos;on error goto gestione_er

Doc = thisComponent
If thisComponent.Sheets.hasByName(&quot;TempR&quot;) Then &apos; se la sheet esiste
thisComponent.Sheets.removebyname(&quot;TempR&quot;)  &apos; la cancella
end if

	oSheets.insertNewByName(&quot;TempR&quot;,4,0)
	print
	oSheetTempR = oSheets.GetByName(&quot;TempR&quot;) &apos;recuperiamo la tabella

	oView = ThisComponent.CurrentController&apos;@@
	oView.setActiveSheet(oSheetTempR) &apos;attiviamola@@
	oDocument = ThisComponent
	oSheetAnalisi = oDocument.Sheets.getByName (&quot;Analisi di Prezzo&quot;) &apos; sheet da cui copiare
	
	oCelle=oDocument.getCurrentSelection().getCellAddress()  &apos; indirizzo cella attiva (qui)
	oSheet2 = oDocument.Sheets.getByName(odocument.currentcontroller.activesheet.name) &apos; sheet (corrente) dove incollare
	oQuelleRange=oSheetAnalisi.getCellRangeByName(&quot;A1:A5000&quot;)  &apos; range da copiare
	oQuellRangeAddresse = oQuelleRange.getRangeAddress &apos; indirizzo cella base del range
    oSheet2.copyRange(oCelle,oQuellRangeAddresse)
    &apos; copiato la col A

	ThisComponent.CurrentController.Select(oMioRange)&apos;@@@@@
	oSheetnum=SheetNameToNumber (&quot;TempR&quot;)
	Dim aSortFields(0) as New com.sun.star.util.SortField
   	Dim aSortDesc(0) as New com.sun.star.beans.PropertyValue

   oDesktop = createUnoService(&quot;com.sun.star.frame.Desktop&quot;)
   oDocument = ThisComponent
   oSheet = oDocument.Sheets().getByIndex(oSheetnum)
   oRange = oSheet.getCellRangeByPosition(0,0,0,5000)  
   aSortFields(0).Field = 0           
   aSortFields(0).SortAscending = False   &apos; descending sort
   aSortDesc(0).Name = &quot;SortFields&quot;
   aSortDesc(0).Value = aSortFields()
   oRange.Sort(aSortDesc())
	nMode = com.sun.star.sheet.CellDeleteMode.ROWS

	sString$ = &quot;----&quot;
	oOrigine=uFindString(sString$, oSheetTempR)
	lrowS = oOrigine.CellAddress.Row
	lrow = lrowS

	 nEndRow = getLastUsedRow(oSheet)

	myrows = oSheet.getrows
	myrows.removebyindex(lrowS,nEndRow)&apos; ripulisce cancellando il resto della colonna

	oRCell = oSheetTempR.getCellByPosition (0,0)
	xA = oRCell.string

	If xA = &quot;inizio analisi&quot; then 
		 aAddress = oRcell.getRangeAddress
		 myrows.removebyindex(0,1)
   		&apos;  oSheetTempR.removeRange(aAddress, nMode)
	end if

&apos;	 inserisciriga vuota  altrimenti non riordina correttamente
	 
	 lRowNum= 1 &apos; numero di righe da inserire
	 oSheet.unprotect(&quot;&quot;)
	oSheet.getRows.insertByIndex(0, lRowNum)&apos;

   oDesktop = createUnoService(&quot;com.sun.star.frame.Desktop&quot;)
   oDocument = ThisComponent
   oSheet = oDocument.Sheets().getByIndex(oSheetnum)
   oRange = oSheet.getCellRangeByPosition(0,0,0,5000)  
   aSortFields(0).Field = 0           
   aSortFields(0).SortAscending = true&apos; False   &apos; descending sort
   aSortDesc(0).Name = &quot;SortFields&quot;
   aSortDesc(0).Value = aSortFields()
   oRange.Sort(aSortDesc())
	sString$ = &quot;Fine ANALISI&quot;
	oOrigine=uFindString(sString$, oSheetTempR)
 	lrowFine = oOrigine.CellAddress.Row
 	oRangeRow = oSheetTempR.getCellRangeByPosition (0,lrowFine,10,lrowFine)
 	aAddress = oRangeRow.getRangeAddress
   	oSheetTempR.removeRange(aAddress, nMode)
&apos;   	print &quot;&quot;
	lrow =0
		oRCell = oSheetTempR.GetCellByPosition( 0 , lrow )
  &apos; 	ThisComponent.CurrentController.Select(oRCell)&apos;@@@@@@@@
		oTag = oRCell.string
&apos;		print &quot;&quot;
	While oTag &lt;&gt; &quot;&quot;&apos; and(or oTag1 &lt;&gt; &quot;&quot;
		oTag = oRCell.string
		lrow = lrow +1
		oRCell = oSheetTempR.GetCellByPosition( 0 , lrow )
		oTag1 = oRCell.string
	&apos;	print &quot;&quot;
		If oTag = oTag1 then
			If otag1 = &quot;&quot; then
					oCelle=thisComponent.getCurrentSelection().getCellAddress()    
  						lrow=oCelle.Row
  					&apos; if un po&apos; scemo... da rivedere...  					
				else
					ThisComponent.CurrentController.Select(oRCell)
					MsgBox &quot;ATTENZIONE!!!! &quot;&amp; CHR(10)_
					&amp; &quot;Ho individuato voci diverse con il medesimo codice!!&quot;&amp; CHR(10)_
					&amp; &quot;  Se non risolvi prima l&apos;omonimia non posso riordinare... &quot; &amp; CHR(10) &amp; CHR(10)_
					&amp; &quot;La sigla incriminata Ã¨:  &quot; + oTag  +  &quot;  &quot; &amp; CHR(10) &amp; CHR(10)_
					&amp; &quot;Vai alle Analisi di Prezzo, risolvi il problema e poi riprova... &quot;		
				&apos;	&amp; &quot;La sigla incriminata Ã¨:  &quot; + oTag  +  &quot;                   Vai alle Analisi&quot;_
				&apos;	&amp; &quot; di Prezzo, risolvi il problema e poi riprova... &quot;		
					exit sub
			end if
		end if
	wend
	&apos; se arriva qui vuole dire che non ci sono doppioni...............................
	&apos; e parte a spostare....................................
 &apos;    oSheets =thiscomponent.Sheets

	oCell = oSheet.GetCellByPosition( 0, 0 )
&apos;	ThisComponent.CurrentController.Select(oCell)&apos; debug@@@@
 	oTag1 = oCell.string
 	lrow = 0
 	&apos; ciclo per trovare il primo spazio buono dove inserire la prima analisi riordinata
	lrowE = 1
	oRCell = oSheetAnalisi.GetCellByPosition( 0 , 1 )	
	xA = oRCell.string
	Do While  xA = &quot;&quot;
		lrowE = lrowE+1
		oRCell = oSheetAnalisi.GetCellByPosition( 0 , lrowE )
		xA = oRCell.string
	loop
&apos;	lrowE = lrowE-1
&apos;print
	&apos; ciclo di riordinamento vero e proprio
Do While oTag1 &lt;&gt; &quot;&quot;
	sString$ = oTag1
	oOrigine=uFindString(sString$, oSheetAnalisi)
	 lrowDove = oOrigine.CellAddress.Row

	oCell = oSheetAnalisi.GetCellByPosition( 0, lrowDove )
 	ThisComponent.CurrentController.Select(oCell)&apos;@@@
&apos;
				&apos;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
				oVoce = CircoscrivileAnalisi_7 (lrowDove)
				ThisComponent.CurrentController.Select(oVoce)
	&apos;	print &apos;debug

	&apos;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
		Sposta_range_buono(lrowE)
	
&apos;print &apos;debug
	oSelections = ThisComponent.getCurrentSelection()
&apos;	print
	oRange=oSelections.getRangeAddress()    
	lrowE=oRange.EndRow 
	lrowE = lrowE +1 &apos;riga di inserimento in Analisi
	lrow = lrow +1 &apos;

	oRCell = oSheetTempR.GetCellByPosition( 0 , lrow )
	oTag1 = oRCell.string

Loop

msgbox &quot; Le Analisi sono state riordinate in ordine alfabetico (in Base alla sigla)  Credo sia tutto OK ma meglio controllare&quot;
 &apos; ok Ripulito e riordinato le sigle    
&apos; cancello la sheet... non serve piÃ¹
&apos;thisComponent.Sheets.removebyname(&quot;TempR&quot;)  &apos;riattivare
exit sub
gestione_er:
Msgbox &quot;*/^^oops... un errrore... :-(  e non so neanche dirti da cosa puÃ² dipendere...!&quot;
thisComponent.Sheets.removebyname(&quot;TempR&quot;)
If ThisComponent.Sheets.getByName(&quot;S1&quot;).GetCellByPosition(7,300).value=1 then 
	DETENTORE_GENERALE_ERRORI(sModulSubName, Erl,  Err,  Error$ )
end if

END SUB


Function Disattiva_button  &apos;viene richiamata dopo l&apos;esecuzione 
print &quot;oops... non credevo venisse usata&quot;
	oSheet = ThisComponent.currentController.activeSheet
	oDpage = oSheet.DrawPage
 	oform = oDpage.Forms.getbyname(&quot;WW-Standard&quot;)
 	oCtrlModel = oform.getbyname(&quot;PushButton2&quot;)
 	msgbox oCtrlModel.Enabled
 	oCtrlModel.Enabled = False
&apos; msgbox oCtrlModel.Enabled	
 &apos;	Wait 3000
end Function 
sub Zoo_a_default &apos; da cancellare
print &quot;Focus.Zoo_a_default  - Ma non era disattivata?&quot;	
	oSheet = ThisComponent.Sheets.getByName(&quot;S1&quot;)
	orange = oSheet.getCellRangeByPosition(0,0,0,37)
	oContr = ThisComponent.CurrentController	 
	oContr.select(oRange)
	oContr.ZoomType=OPTIMAL
	oContr.select (oSheet.getCellByPosition(1,1))


	oSheet = ThisComponent.Sheets.getByName(_
	ThisComponent.currentcontroller.activesheet.name)
&apos;	orange = oSheet.getCellRangeByPosition(0,0,15,37)
	orange = oSheet.getCellRangeByPosition(10,0,16,37)
	oContr = ThisComponent.CurrentController	 
	oContr.select(oRange)
&apos;xray oContr &apos;.ZoomType
	oContr.ZoomType=OPTIMAL
	oContr.select (oSheet.getCellByPosition(10,0))
&apos;	oContr.select (oSheet.getCellByPosition(0,0))

end sub
SUB Pesca_cod_0  &apos; probabilmente non usata...
&apos;0) verifica contesto
&apos; decide se azionare Pesca_cod_1 oppure Pesca_cod_2

	oSheet = ThisComponent.currentController.activeSheet
	sSheetName = ThisComponent.currentcontroller.activesheet.name
	If sSheetName=&quot;COMPUTO&quot; or sSheetName=&quot;Analisi di Prezzo&quot; then
	print &quot;3&quot;
		Pesca_cod_1
		exit sub
	end if
	If sSheetName=&quot;Elenco Prezzi&quot; then
		Pesca_cod_2
		exit sub
	end if
&apos;	msgbox &quot;questa macro va usata solo su Computo o su EP&quot;
END SUB
sub Struttura_ComputoCONT &apos;PROVA  PROVA per il foglio contabilita  NON USATA
print &quot;questo&quot;  
	&apos;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; per evitare che duplichi la struttura
	 Togli_Struttura
	 &apos;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
	Ripristina_statusLine
	Barra_Apri_Chiudi_5(&quot;1C  Sto creando le strutture... Pazienta...&quot;, 10)
	oSheet = ThisComponent.currentController.activeSheet &apos;oggetto sheet
	iSheet = oSheet.RangeAddress.sheet &apos; index della sheet
	sAttributo = Trova_Attr_Sheet
    If sAttributo &lt;&gt; &quot;Tipo_computo&quot; Then	
 			 msgbox &quot;Questa macro si può usare solo in una tabella di COMPUTO! (o sua copia...)&quot;
			exit sub
	end if
   	if ThisComponent.currentcontroller.activesheet.name = &quot;COMPUTO&quot; then
		s_R = &quot;&quot;
	end if
	if ThisComponent.currentcontroller.activesheet.name = &quot;CONTABILITA&quot; then
		s_R = &quot;_R&quot;
	end if		
	if right( (oSheet.GetCellByPosition(0 ,5).CellStyle), 2) = &quot;_R&quot; or	_
				right( (oSheet.GetCellByPosition(0 ,6).CellStyle), 2) = &quot;_R&quot; or _
				right( (oSheet.GetCellByPosition(0 ,7).CellStyle), 2) = &quot;_R&quot; or _
				right( (oSheet.GetCellByPosition(0 ,8).CellStyle), 2) = &quot;_R&quot; then
				s_R = &quot;_R&quot;	
	end if	

	
	lStartRow = oSheet.GetCellByPosition( 0 , 0)
&apos;	lLastUrowNN = getLastUsedRow(oSheet)
	
	sString$ = &quot;Fine Computo&quot;
	
	oEnd=uFindString(sString$, oSheet) 
	If isNull (oEnd) or isEmpty (oEnd)  then 
						lLastUrowNN = getLastUsedRow(oSheet)-1
					else
						lLastUrowNN=oEnd.RangeAddress.EndRow -1
	end if
	IF lLastUrowNN	&gt;= 600 and lLastUrowNN	&lt;= 1000 then
		if msgbox (&quot;Questa tabella è piuttosto corposa e ci vorrà un po&apos; di tempo! &quot; &amp; CHR$(10)_
		 	&amp; &quot;   (alcuni minuti...)  &quot; &amp; CHR$(10) &amp; CHR$(10)_
			&amp;&quot;         PROSEGUO ?... &quot; &amp; CHR$(10) _
   			&amp;  CHR$(10) &amp; &quot;&quot;,36, &quot;Creazione STRUTTURE&quot;) = 7 then
   			exit sub
    	end if
	end if
	IF lLastUrowNN	&gt; 1001 then
		if msgbox (&quot;Questa tabella è piuttosto corposa e ci vorrà un po&apos; di tempo! &quot; &amp; CHR$(10)_
			&amp; &quot;   ( Parecchi  minuti...)  &quot; &amp; CHR$(10) &amp; CHR$(10)_
			&amp;&quot;         PROSEGUO ?... &quot; &amp; CHR$(10) _
   			&amp;  CHR$(10) &amp; &quot;&quot;,36, &quot;Creazione STRUTTURE&quot;) = 7 then
   			exit sub
    	end if
	end if
	&apos;lLastUrowNN=oEnd.RangeAddress.EndRow-1
	ThisComponent.Sheets.getByName(&quot;S1&quot;).GetCellByPosition(7,280).string = NOW &apos;debug
	Ripristina_statusLine
	Barra_Apri_Chiudi_5(&quot;2  Sto creando le strutture... Pazienta...&quot;, 15)
	iLivelliVisibili = ThisComponent.Sheets.getByName(&quot;S1&quot;).GetCellByPosition(7,297).value 
	if iLivelliVisibili=0 then &apos;per avere comunque un valore di default nel caso il riferimento sia vuoto
			iLivelliVisibili = 2
	end if
For I = 3  to lLastUrowNN
Dim oCRA As New com.sun.star.table.CellRangeAddress
	iRiga = i
&apos;	do while oSheet.GetCellByPosition(0 , i).CellStyle = &quot;Livello-1-scritta&quot; &amp; s_R
			
		&apos;		print left((oSheet.GetCellByPosition(1 , (I)).CellStyle),7) &apos;debug
		&apos; se è dentro una intestazione di capito o sottoCap
		if	oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Comp Start Attributo_R&quot; &amp; s_R or _
		 		oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Livello-1-scritta&quot; &amp; s_R or _
		 		oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;livello-1-sotto_&quot; &amp; s_R  or _
			 	oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;livello2 valuta&quot;  &amp; s_R   or _
			 	oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;livello-2-sotto_&quot;  &amp; s_R   or _
			 	oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;livello2 sopra&quot;  &amp; s_R  or _
			 	oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Default&quot;  or _
			 	left((oSheet.GetCellByPosition(1 , (I)).CellStyle),7) = &quot;Reg-SAL&quot; then	 &apos;questa per usare stile gerarchico
	&apos;	ThisComponent.CurrentController.Select(oSheet.GetCellByPosition(1 ,I )) &apos;debug	
	&apos;	print &quot;cap &quot; &amp;  oSheet.GetCellByPosition(1 ,I ).CellStyle
				goto prossima &apos; passa alla riga dopo
			else 
				iRI=I
				Do while oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Comp-Bianche sopra&quot; &amp; s_R OR  _
						oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;comp Art-EP&quot;  &amp; s_R OR  _
						oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Comp-Bianche in mezzo&quot;  &amp; s_R OR  _
						oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;comp sotto Bianche&quot;  &amp; s_R &apos; &apos; prima avevo OR
				&apos;	ThisComponent.CurrentController.Select(oSheet.GetCellByPosition(1 ,I )) &apos;debug	
				&apos;	print oSheet.GetCellByPosition(1 ,I ).CellStyle
						if oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Comp-Bianche in mezzo&quot; &amp; s_R  then
							iRIs = I
							Do while oSheet.GetCellByPosition(1 , (I)).CellStyle = &quot;Comp-Bianche in mezzo&quot; &amp; s_R 
							&apos;	ThisComponent.CurrentController.Select(oSheet.GetCellByPosition(1 ,I )) &apos;debug
							&apos;	print &apos;ThisComponent.CurrentController.Select(oSheet.GetCellByPosition(1 ,I )).CellStyle&apos;debug
								I = I + 1 &apos;genni
							loop
							if iRIs &gt; I-1 then
									ThisComponent.CurrentController.Select(oSheet.getCellByPosition(1,iRI))
									beep
									oCRA.EndRow = iRIs
									msgbox &quot;1 Da queste parti lo stile delle righe non sembra ordinato! &quot; &amp; I-1 &amp; CHR$(10)_
											&amp; &quot;Io ho raggruppato ugualmente... ma se la struttura non ti sembrerà ordinata non dare la colpa a me... -;)&quot;	
								else
									oCRA.EndRow = I-1	
							end if
							oCRA.Sheet =iSheet
							oCRA.StartColumn = 	4
							oCRA.StartRow = iRIs
							oCRA.EndColumn =  9
							oSheet.group(oCRA,1,1)
							oSheet.showLevel(iLivelliVisibili-1,1)
							&apos;oSheet.hideDetail(oCRA)
						end if
						I=I+1
				loop
				&apos;print &quot;michiaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;
				if iRI &gt; I-1 then
						ThisComponent.CurrentController.Select(oSheet.getCellByPosition(1,iRI))
						beep
						oCRA.EndRow = iRi
						msgbox &quot;In questo punto lo stile delle righe non sembra ordinato! &quot;&amp; CHR$(10)_
								&amp; &quot;Io ho raggruppato ugualmente... ma se la struttura non ti sembrerà ordinata non dare la colpa a me... -;)&quot;	
					else
						oCRA.EndRow = I-1	
				end if
				oCRA.Sheet =iSheet
				oCRA.StartColumn = 	5
				oCRA.StartRow = iRI
				oCRA.EndColumn =  5
				&apos;oCRA.EndRow = I-1
				oSheet.group(oCRA,1)
			&apos;	oSheet.hideDetail(oCRA)
				oSheet.showLevel(iLivelliVisibili-1,1)
			&apos;	oSheet.showLevel(1,1)

				I = I+1 
		end if
		prossima:
	&apos;	ThisComponent.CurrentController.Select(oSheet.GetCellByPosition(1 ,I )) &apos;debug	
	&apos;	print oSheet.GetCellByPosition(1 ,I ).CellStyle
	&apos;	if i = 10 then &apos; and i &lt;= lLastUrowNN / 4 + 1 then
		&apos;	Ripristina_statusLine
			sTxt = &quot;Sto creando le strutture e sono alla riga &quot; &amp; i
		&apos;	Barra_Apri_Chiudi_5( stxt, 50)
	&apos;	end if
		goto salta_debug

		Ripristina_statusLine
		Barra_Apri_Chiudi_5(sTxt, lLastUrowNN/5*100/lLastUrowNN)
		if i &gt;= lLastUrowNN / 4 then &apos; and i &lt;= lLastUrowNN / 4 + 1 then
			Ripristina_statusLine
			Barra_Apri_Chiudi_5(sTxt, lLastUrowNN/4*100/lLastUrowNN)
		end if
		if i &gt;= lLastUrowNN/4*2 then &apos;and i &lt;= lLastUrowNN/4*2 + 1 then
			Ripristina_statusLine
			Barra_Apri_Chiudi_5(sTxt , lLastUrowNN/4*2*100/lLastUrowNN)
		end if
		if i &gt;= lLastUrowNN/4*3 then &apos;and i &lt;= lLastUrowNN/4*3 + 1 then
			Ripristina_statusLine
			Barra_Apri_Chiudi_5(sTxt, lLastUrowNN/4*3*100/lLastUrowNN)
		end if

		salta_debug:
next I

	oCRA.Sheet =iSheet
	oCRA.StartColumn = 	4
	oCRA.StartRow = 1
	oCRA.EndColumn =  8
	oCRA.EndRow = 100
	oSheet.group(oCRA,0)
	Ripristina_statusLine
	&apos;ThisComponent.Sheets.getByName(&quot;S1&quot;).GetCellByPosition(7,281).string = NOW &apos;debug
end sub
SUB Accoda_Marche(livelli as long,  lrow as long) &apos; Questa non credo sia utilizzata... ma per il momento rimane
&apos;print &quot;Dovrebbe esere disattivata... (Sub Accoda_Marche)&quot;
&apos;exit sub
	
  oSheet = ThisComponent.currentController.activeSheet &apos; sheet corrente 
 
  oCell = oSheet.GetCellByPosition( 2, lrow-1 )   
 &apos; ThisComponent.CurrentController.Select(oCell)&apos;debug	
  oSheetTemp = thisComponent.sheets.getbyname(&quot;Temp&quot;) 
  dim iIncMan as double
  
  	if oSheetTemp.getCellByPosition(5,1).string = &quot;incid. manodopera&quot;  or _
  		oSheetTemp.getCellByPosition(6,1).string &lt;&gt; &quot;&quot; then
	&apos;	 sIncMan = oSheetTemp.GetCellByPosition( 8, lrow).getvalue
	end if

    sIncMan = oSheet.GetCellByPosition( 8, lrow).getvalue
    sSicur = oSheet.GetCellByPosition( 9, lrow).getvalue
   &apos; print sIncMan
 
	if oSheet.GetCellByPosition( 7, lrow).value = isNotANumber then
			Prezzo = oSheet.GetCellByPosition( 7, lrow).getstring
				else
			Prezzo = oSheet.GetCellByPosition( 7, lrow).getvalue
	end if
	sUM =  oSheet.GetCellByPosition( 6, lrow).string
	sDescr0 = oSheet.GetCellByPosition( 4, lrow).string
	sAlfaNum0 = oSheet.GetCellByPosition( 2, lrow).string
&apos;	print sAlfaNum0
	sAlfaNum1 = oSheet.GetCellByPosition( 2, lrow-1).string
&apos;	print sAlfaNum1
	lAlfa0 = Len (sAlfaNum0)
	oCell = oSheet.GetCellByPosition( 2, lrow )
	lAlfaA = Len(oCell.string)
	sAlfac1 = oSheet.GetCellByPosition( 2, lrow-1).string
	sCategoria = oSheet.GetCellByPosition( 0, lrow).string
	oSheetTemp = thisComponent.sheets.getbyname(&quot;Temp&quot;)
  
  &apos;	print lAlfa0
&apos;	print lAlfaA
&apos;print livelli
	Select Case livelli

	Case  1 
	
	msgbox &quot;il livello in questo caso deve essere impostato a 2&quot;
	exit sub
	&apos;	lAlfaA = Len(sAlfaNum1)
	&apos;	Do while lAlfa0 = lAlfaA 
	&apos;			lrow = lrow-1
	&apos;			oCell = oSheet.GetCellByPosition( 2, lrow )
				&apos;lAlfaA = Len( oCell.string)
	&apos;			sAlfaNum1  = oSheet.GetCellByPosition( 2, lrow).string	
	&apos;&apos;			ThisComponent.CurrentController.Select(oCell)&apos;debug	
	&apos;			print &quot;AAA&quot;		
	&apos;	loop 
	&apos;	lrow = lrow+1
	&apos;	sDescr1 =  oSheet.GetCellByPosition( 4, lrow-1).string

	Case 2 &apos; per Marche
print lrow
			lrow = lrow-1
			oCell = oSheet.GetCellByPosition( 2, lrow )
			lAlfaA = Len( oCell.string)
			sAlfac1 = oSheet.GetCellByPosition( 2, lrow).string
print sAlfac1
&apos;print oSheet.GetCellByPosition( 2, lrow+1).string
&apos;print oSheet.GetCellByPosition( 2, lrow).string
			if oSheet.GetCellByPosition( 6, lrow-1).string = &quot;&quot; AND _
			 	 sAlfac1 &lt;&gt; oSheet.GetCellByPosition( 2, lrow-1).string	then &apos;oSheet.GetCellByPosition( 2, lrow).string then
		&apos;	print &quot;diretto&quot;
				goto voce_completa
			end if 
			Do while sAlfac1 = oSheet.GetCellByPosition( 2, lrow-1).string
				if oSheet.GetCellByPosition( 6, lrow).string = &quot;&quot; then
					sDescr1 =  oSheet.GetCellByPosition( 4, lrow).string
					print sDescr1
					goto voce_completa
				end if 
				lrow = lrow-1	
				ThisComponent.CurrentController.Select(oSheet.GetCellByPosition( 2, lrow))&apos;debug	
				print &quot;proseguo&quot;
			loop 
			print lrow &amp; &quot;  in uscita&quot;
		&apos;	lrow = lrow +1
			sDescr1 =  oSheet.GetCellByPosition( 4, lrow).string
	print 	sDescr1
			If sAlfac1 = &quot;P&quot; then &apos; se è milano...	
		&apos;	print &quot;MI&quot;
					goto voce_completa
			end if
			goto voce_completa
			oCell = oSheet.GetCellByPosition( 2, lrow )
			lAlfa0 = lAlfaA
			lAlfaA = Len( oCell.string)
	
			Do while lAlfaA = lAlfa0 
				lrow = lrow-1
				oCell = oSheet.GetCellByPosition( 2, lrow )
				lAlfaA = Len( oCell.string)
				sAlfac1 = oSheet.GetCellByPosition( 3, lrow).string
			&apos;		ThisComponent.CurrentController.Select(oCell)&apos;debug	
			&apos;	print sAlfac1

			loop
			IF lAlfaA &gt; lAlfa0 then
		&apos;		goto voce_completa
			end if
			sDescr2 =  oSheet.GetCellByPosition( 4, lrow).string			
			oCell = oSheet.GetCellByPosition( 2, lrow )

	Case 3 &apos;
	&apos;	msgbox &quot;il livello in questo caso deve essere impostato a 2&quot;
	&apos;	exit sub
&apos;	print &quot;sono in tip 3&quot;
			lrow = lrow-1
			oCell = oSheet.GetCellByPosition( 2, lrow )
			lAlfaA = Len( oCell.string)
			sAlfac1 = oSheet.GetCellByPosition( 3, lrow).string

			Do while lAlfaA = lAlfa0  AND sAlfac1 &lt;&gt; &quot;P&quot; 
				lrow = lrow-1
				oCell = oSheet.GetCellByPosition( 2, lrow )
				lAlfaA = Len( oCell.string)
				sAlfac1 = oSheet.GetCellByPosition( 3, lrow).string			
			&apos;	ThisComponent.CurrentController.Select(oCell)&apos;debug	
			&apos;	print sAlfac1
			loop 
			sDescr1 =  oSheet.GetCellByPosition( 4, lrow).string
&apos;	print &quot;1   &quot; &amp; sDescr1
			If sAlfac1 = &quot;P&quot; then &apos; se è milano...
	
					sDescr1 =  oSheet.GetCellByPosition( 4, lrow).string
					goto voce_completa
			end if
			
&apos;		PRINT &quot;SECONDO&quot;
			&apos;lrow = lrow+1 
			oCell = oSheet.GetCellByPosition( 2, lrow )
		&apos;	ThisComponent.CurrentController.Select(oCell)&apos;debug	
	&apos;	print &quot;dove&quot;	
		&apos;	lAlfa1 = lAlfaA
			lAlfa1 =  Len( oCell.string)
			lrow = lrow-1
			oCell = oSheet.GetCellByPosition( 2, lrow )
			lAlfaB = Len( oCell.string)
			IF lAlfaB &gt; lAlfa1 then
			&apos;		print lAlfaB &amp; &quot; ancora &quot; &amp; lAlfa1
					Do while lAlfaB &gt;= lAlfa1
						lrow = lrow-1
						oCell = oSheet.GetCellByPosition( 2, lrow )
						lAlfaB = Len( oCell.string)
					&apos;	ThisComponent.CurrentController.Select(oCell)&apos;debug	
				&apos;		print &quot;3c&quot;
					loop
					sDescr2 =  oSheet.GetCellByPosition( 4, lrow).string
				else
				&apos;	ThisComponent.CurrentController.Select(oCell)&apos;debug	
				&apos;		print &quot;Altern&quot;
					sDescr2 =  oSheet.GetCellByPosition( 4, lrow).string
			end if
		
			IF lAlfaA &gt; lAlfa0 then
			
		&apos;&apos;		goto voce_completa
			end if
		&apos;	sDescr2 =  oSheet.GetCellByPosition( 4, lrow).string
		&apos;	print &quot;2   &quot; &amp; sDescr2			
			oCell = oSheet.GetCellByPosition( 0, 0 )
	&apos;			oCell = oSheet.GetCellByPosition( 2, lrow )


	End select
	 

	voce_completa:

	If sDescr1 = sDescr2 then &apos; su milano ci sono voci dove 
	&apos;la descr è ripetuta tal quale... e possiamo eliminarla subito.
		sDescr2 = &quot;&quot;  &apos;
	end if
	If sDescr0 = sDescr1 then
		sDescr1 = &quot;&quot;
	end if	
	
	oUltimo_indirizzo_conosciuto = ThisComponent.CurrentSelection

&apos; tutti i dati sono adesso stivati nelle variabili procedo a ripulire e incollare
	oSheet = oSheetTemp
	Thiscomponent.currentcontroller.setactivesheet(oSheet)


	Flags = com.sun.star.sheet.CellFlags.STRING + _
			com.sun.star.sheet.CellFlags.VALUE + _
			com.sun.star.sheet.CellFlags.FORMULA
	oRange = oSheet.getCellRangeByPosition (1,2,7,2)
  	oRange.clearContents(Flags) &apos;@@@ pare non cancellare tutto... aggiungere flag?
&apos;print sCategoria
	if sCategoria &lt;&gt; &quot;&quot; then
&apos;		oSheet.getCellByPosition(5,5).string = sCategoria 
	end if

	SCompleta1 = sAlfaNum0
&apos;	oSheet.getCellByPosition(1,2).string = SCompleta1

	if Len( sDescr3) &lt;&gt; 0  then
		 sDescr3 =  sDescr3  &amp;  CHR(13)
	end if
	if Len( sDescr2) &lt;&gt; 0 then
		 sDescr2 =  sDescr2  &amp;  CHR(13)
	end if
	if Len( sDescr1) &lt;&gt; 0 then
		 sDescr1 =  sDescr1  &amp;  CHR(13)
	end if
	
	&apos; introdotto con TV
	&apos; azioni diverse per TV e T3
&apos;	print oSheet.getCellByPosition(5,1).string
	if oSheet.getCellByPosition(5,1).string = &quot;incid. manodopera&quot;  or _
		oSheet.getCellByPosition(6,1).string &lt;&gt; &quot;&quot; then
			if sIncMan&lt;&gt; 0 then
				oSheet.getCellByPosition(5,2).value = sIncMan &apos;SCompleta0
			end if		
&apos;PRINT &quot;DDDDD&quot;&apos;
&apos;			SCompleta5 = &quot;=_CONCATENATE(&quot;&quot;(&quot;&quot;;G5; &quot;&quot;)&quot;&quot;; &quot;&quot;    &quot;&quot;; &quot; &amp; &quot;  &quot; &amp; &quot;&quot;&quot;&quot; &amp; sAlfaNum0 &amp; &quot;&quot;&quot;&quot; &amp; &quot;)&quot;
			SCompleta5 = &quot;=CONCATENATE(&quot;&quot;(&quot;&quot;;G5; &quot;&quot;)&quot;&quot;; &quot;&quot;    &quot;&quot;; &quot; &amp; &quot;  &quot; &amp; &quot;&quot;&quot;&quot; &amp; sAlfaNum0 &amp; &quot;&quot;&quot;&quot; &amp; &quot;)&quot;
			oSheet.getCellByPosition(6,2).formula = SCompleta5
		Else
	&apos;		SCompleta5 = &quot;=CONCATENATE(&quot;&quot;(&quot;&quot;;F5; &quot;&quot;)&quot;&quot;; &quot;&quot;    &quot;&quot;; &quot; &amp; &quot;  &quot; &amp; &quot;&quot;&quot;&quot; &amp; sAlfaNum0 &amp; &quot;&quot;&quot;&quot; &amp; &quot;)&quot;
			SCompleta5 = &quot;=CONCATENATE(&quot;&quot;(&quot;&quot;;F5; &quot;&quot;)&quot;&quot;; &quot;&quot;    &quot;&quot;; &quot; &amp; &quot;  &quot; &amp; &quot;&quot;&quot;&quot; &amp; sAlfaNum0 &amp; &quot;&quot;&quot;&quot; &amp; &quot;)&quot;
			oSheet.getCellByPosition(5,2).formula = SCompleta5
	end if
	
	if oSheet.getCellByPosition(7,1).value &lt;&gt; &quot;&quot; then
		if sSicur &lt;&gt; 0 then 
			oSheet.getCellByPosition(7,2).value = sSicur
		end if
	end if
	
	SCompleta2 = sDescr3 &amp; sDescr2 &amp; sDescr1 &amp; sDescr0
 	oSheet.getCellByPosition(2,2).string=SCompleta2

	SCompleta3 = sUM
	oSheet.getCellByPosition(3,2).string=SCompleta3 

	SCompleta4 = Prezzo
	oSheet.getCellByPosition(4,2).value = SCompleta4  &apos;Attenzione!	
	&apos; il prezzo DEVE essere un numero VERO (non stringa)

    oCell=oSheet.getCellByPosition(2,2) 
 &apos;   ThisComponent.CurrentController.Select(oCell)
 &apos;   Adatta_Altezza_riga 	
    sQualeCella = &quot;$C$3&quot;
    Seleziona_Cella (sQualeCella)
       Adatta_Altezza_riga 	
 &apos;   pRINT &quot;ACCODA NORMAL&quot;
end sub
</script:module>